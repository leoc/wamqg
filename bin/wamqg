#!/usr/bin/env ruby

$: << File.dirname(__FILE__)+'/../lib/'

require 'wamqg/wamqg'

AMQP_CONFIG = { host: '127.0.0.1' }

EM.run do
  trap('TERM') do
    if !shutdown
      puts "\rInitiating graceful shutdown."
      Wamqg::WAMQG.stop
      shutdown = true
    else
      puts "\rPlease be patient."
    end
  end

  CHANNEL = AMQP::Channel.new(AMQP.connect(AMQP_CONFIG)) do |channel|
    EXCHANGE = channel.topic('pub/sub') do |exchange|
      Wamqg::WAMQG.start
      shutdown = false
    end
  end
end
