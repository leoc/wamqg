#!/usr/bin/env ruby

$: << File.dirname(__FILE__)+'/../lib/'

require 'wamqg'

AMQP_CONFIG = { host: '127.0.0.1' }

EM.run do
  trap('TERM') do
    if !shutdown
      puts "\rInitiating graceful shutdown."
      WAMQG.stop
      shutdown = true
    else
      puts "\rPlease be patient."
    end
  end

  CHANNEL = AMQP::Channel.new(AMQP.connect(AMQP_CONFIG)) do |channel|
    EXCHANGE = channel.topic('pub/sub', auto_delete: true) do |exchange|
      WAMQG.start
      shutdown = false
    end
  end
end
